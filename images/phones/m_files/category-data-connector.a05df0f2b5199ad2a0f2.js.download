(window.webpackJsonp=window.webpackJsonp||[]).push([["category-data-connector"],{"5nU7":function(e,t,a){"use strict";a.r(t),a.d(t,"CategoryDataActions",(function(){return o})),a.d(t,"CategoryDataConnector",(function(){return D})),a.d(t,"CategoryDataReducer",(function(){return l})),a.d(t,"ToolingInfo",(function(){return m}));var r=a("G82u");class o{}o.updateCategoryDocumentMap=new r.a("updateCategoryDocumentMap");var n=a("D57K"),i=a("1w6q"),c=a("rvYQ"),s=a("gvPr"),g=a("FJcQ"),u=a("HxRh");var d=a("u5KZ"),h=a("KETb");class D extends i.a{constructor(e,t,a,r,o,n){super(e,t,a,r,o,n),this.useIndexedDb=!1,this.categoryDataCacheMap=new Map,this.categoryDocumentPromiseMap=new Map;const i=c.a.CurrentRequestTargetScope;c.a.Environment||s.a.prod;this.baseConfigUrl=i&&c.a.ConfigRootUrl||c.a.EnvironmentConfigUrl,this.readCategoryDataFromIndexDb(),!c.a.HostPage||!c.a.HostPage.verticalKey||n.optedOutVerticalKeys&&n.optedOutVerticalKeys.includes(c.a.HostPage.verticalKey)||this.getCategoryDocumentForVertical(c.a.HostPage.verticalKey)}getCategoryDetail(e,t){return Object(n.b)(this,void 0,void 0,(function*(){try{const a=t?e:"start",r=t||e,o=yield this.getCategoryDocumentForVertical(a);if(!(o.categories&&Object.keys(o.categories).length>0))throw Error(`The category document for the vertical ${a} is empty`);if(!o.categories[r])throw Error(`The category: ${r} is not present in the category document for the vertical: ${a}`);return Promise.resolve(o.categories[r])}catch(e){return d.a.sendAppErrorEvent(Object.assign(Object.assign({},u.G.CategoryDataGetCategoryDetail),{message:e.toString()})),Promise.reject(e)}}))}getDisplayTextForCategory(e,t){return Object(n.b)(this,void 0,void 0,(function*(){return this.getCategoryDetail(e,t).then(e=>e.displayText)}))}getUrlSegmentForCategory(e,t){return Object(n.b)(this,void 0,void 0,(function*(){return this.getCategoryDetail(e,t).then(e=>e.urlSegment)}))}fetchCategoryDocumentForVertical(e,t){return Object(n.b)(this,void 0,void 0,(function*(){if(!this.indexedDb||!this.useIndexedDb)return this.fetchCategoryDocument(e);const a=this.categoryDataCacheMap.get(c.a.CurrentMarket+"|"+t);return a&&a.categoryDocumentData?a.categoryDocumentData:this.getCategoryDocumentAndRefreshCache(e,t)}))}readCategoryDataFromIndexDb(){return Object(n.b)(this,void 0,void 0,(function*(){if(this.indexedDb=new g.a,this.useIndexedDb=this.indexedDb.supported&&!c.a.DisableCachingConfigs&&this.indexedDb.isCachingAllowed,this.useIndexedDb)try{this.indexedDb.initializeIndexedDb(1,"CategoryDocument","MSNewsCategoryDocument").then(()=>{this.populateCategoryDataMapFromIndexedDb()})}catch(e){d.a.sendAppErrorEvent(Object.assign(Object.assign({},u.G.CategoryDataIndexedDbInitializationFailed),{message:"Failed on IndexedDb initialization for Category Data connector. Error Details: "+e}))}}))}populateCategoryDataMapFromIndexedDb(){try{this.categoryDataCacheMap.clear(),this.indexedDb.getAllObjects().then(e=>{e&&e.forEach(e=>{this.isCategoryDocumentStale(e.storageTimestamp)||this.categoryDataCacheMap.set(e.categoryDocumentKey,e)})})}catch(e){d.a.sendAppErrorEvent(Object.assign(Object.assign({},u.G.CategoryDataIndexedDbBulkReadFailed),{message:"Failed on bulk read from IndexedDb for Category Data connector. Error Details: "+e}))}}getCategoryDocumentForVertical(e){return Object(n.b)(this,void 0,void 0,(function*(){if(this.categoryDocumentPromiseMap.has(e))return this.categoryDocumentPromiseMap.get(e);const t=this.getCurrentState();if(t.categoryDocumentMap.has(e))return t.categoryDocumentMap.get(e);let a=!1;const r=new Promise((t,r)=>Object(n.b)(this,void 0,void 0,(function*(){try{const r=this.config.categoryDocumentLinks[e]||null;if(!r)throw Error("Not a valid vertical key present in the config");const n=yield this.fetchCategoryDocumentForVertical(r,e);o.updateCategoryDocumentMap.getActionSender(this).send(e,n),t(n)}catch(e){r(e)}finally{a=!0,this.categoryDocumentPromiseMap.delete(e)}})));return a||this.categoryDocumentPromiseMap.set(e,r),r}))}isCategoryDocumentStale(e){return!e||(new Date).getTime()-e>9e5}getCategoryDocumentAndRefreshCache(e,t){return Object(n.b)(this,void 0,void 0,(function*(){const a=c.a.CurrentMarket+"|"+t;return this.fetchCategoryDocument(e).then(e=>{try{const t={categoryDocumentKey:a,categoryDocumentData:e,storageTimestamp:(new Date).getTime()};this.categoryDataCacheMap.set(a,t),this.indexedDb.setObject(a,t)}catch(e){d.a.sendAppErrorEvent(Object.assign(Object.assign({},u.G.CategoryDataIndexedDbWriteFailed),{message:"Failed on writing data into IndexedDb for Category Data connector. Error Details: "+e}))}return e})}))}fetchCategoryDocument(e){return Object(n.b)(this,void 0,void 0,(function*(){const t=new URL(`${e}${this.baseConfigUrl.search}`,this.baseConfigUrl);return yield Object(h.a)(()=>Object(n.b)(this,void 0,void 0,(function*(){const e=yield fetch(t.href,null);if(!e.ok)throw Error(e.statusText);return e.json()})),"getCategoryDocument")}))}}var y=a("05Au");class l{constructor(){this.InitialState={categoryDocumentMap:new Map}}reduce(e,t){if(!e)return this.InitialState;if(!t)return e;let a;return y.a.handleAction(t,o.updateCategoryDocumentMap,(t,r)=>{const o=new Map(e.categoryDocumentMap);o.set(t,r),a=Object.assign(Object.assign({},e),{categoryDocumentMap:o})}),a||e}}const m={experienceConfigSchema:{}}}}]);